@page "/calendar"
@implements IDisposable
@inject MeroDiary.ViewModels.Calendar.CalendarViewModel Vm

<h1>Calendar</h1>

@if (!string.IsNullOrWhiteSpace(Vm.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@Vm.ErrorMessage</div>
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <button class="btn btn-outline-secondary" @onclick="Prev" disabled="@Vm.IsBusy">◀</button>
    <h3 class="m-0">@Vm.MonthTitle</h3>
    <button class="btn btn-outline-secondary" @onclick="Next" disabled="@Vm.IsBusy">▶</button>
</div>

@if (Vm.Days.Count != 42)
{
    <p><em>Loading calendar…</em></p>
}
else
{
<table class="table table-bordered align-middle text-center">
    <thead>
        <tr>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
            <th>Sun</th>
        </tr>
    </thead>
    <tbody>
        @for (var week = 0; week < 6; week++)
        {
            <tr>
                @for (var day = 0; day < 7; day++)
                {
                    var item = Vm.Days[(week * 7) + day];
                    var cls = item.IsInCurrentMonth ? "" : "text-muted";
                    if (item.IsToday) cls = $"{cls} fw-bold";

                    <td class="@cls" style="width: 14.285%;">
                        <button class="btn btn-link text-decoration-none p-0"
                                @onclick="() => Select(item)"
                                disabled="@Vm.IsBusy">
                            @item.Date.Day
                        </button>

                        @if (item.HasEntry)
                        {
                            <div class="mt-1">
                                <span class="badge bg-success">Entry</span>
                            </div>
                        }
                    </td>
                }
            </tr>
        }
    </tbody>
</table>
}

<p class="text-muted">
    Tip: selecting a date opens the Journal page. If an entry exists, it opens in View Mode; otherwise it starts a new entry for that date.
</p>

@code
{
    protected override async Task OnInitializedAsync()
    {
        Vm.PropertyChanged += VmOnPropertyChanged;
        await Vm.InitializeAsync();
    }

    private void VmOnPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
        => _ = InvokeAsync(StateHasChanged);

    public void Dispose()
        => Vm.PropertyChanged -= VmOnPropertyChanged;

    private Task Prev() => Vm.GoToPreviousMonthAsync();
    private Task Next() => Vm.GoToNextMonthAsync();
    private void Select(MeroDiary.ViewModels.Calendar.CalendarDayItem day) => Vm.SelectDate(day);
}


